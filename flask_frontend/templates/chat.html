<!-- flask_frontend/templates/chat.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SchoolData Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="chat-body">
  <div class="chat-layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="avatar-circle">
          {{ user_name[:1] | upper }}
        </div>
        <div>
          <div class="user-name">{{ user_name }}</div>
          <div class="user-role">{{ user_role | capitalize }}</div>
          <div class="user-email">{{ user_email }}</div>
        </div>
      </div>

    <!-- LOGO SECTION (replaces the old Tips section) -->
    <div class="sidebar-section logo-block">
        <img src="{{ url_for('static', filename='logo.png') }}"
            alt="School Logo"
            class="school-logo">

        <div class="school-name">
            ABCD International School
        </div>
    </div>



    <div class="sidebar-footer">
      {% if user_role == "teacher" %}
        <a href="{{ url_for('kpi_page') }}" class="btn-secondary kpi-link">
          ðŸ“Š KPI Dashboard
        </a>
      {% endif %}
      <a href="{{ url_for('logout') }}" class="btn-secondary logout-btn">Logout</a>
    </div>


    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
      <header class="chat-header">
        <h1>School Data Assistant</h1>
        <span class="status-dot"></span><span class="status-text">ABCD International School</span>
      </header>

      <section id="chat-window" class="chat-window">
        <!-- Messages will be injected here by JS -->
      </section>

      <div id="typing-indicator" class="typing-indicator hidden">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>

      <form id="chat-form" class="chat-input-bar">
        <textarea id="chat-input" rows="1" placeholder="Ask something about your school data..." required></textarea>
        <button type="submit" class="btn-primary">Send</button>
      </form>
    </main>

  </div>

  <script>
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");
    const chatWindow = document.getElementById("chat-window");
    const typingIndicator = document.getElementById("typing-indicator");

    function addMessage(text, sender = "user") {
      const msg = document.createElement("div");
      msg.classList.add("chat-message", sender === "user" ? "from-user" : "from-bot");

      const bubble = document.createElement("div");
      bubble.classList.add("bubble");
      bubble.textContent = text;
      msg.appendChild(bubble);

      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage(message) {
      typingIndicator.classList.remove("hidden");

      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ message }),
        });

        const data = await resp.json();
        typingIndicator.classList.add("hidden");

        if (!resp.ok || data.error) {
          addMessage(data.error || "Something went wrong.", "bot");
          return;
        }

        // Show AI summary as chat message
        if (data.summary) {
          addMessage(data.summary, "bot");
        } else {
          addMessage("I got your request and processed it.", "bot");
        }

        // (Optional) You can also log or inspect data.sql and data.results in console
        console.log("SQL used:", data.sql);
        console.log("Results:", data.results);

      } catch (err) {
        typingIndicator.classList.add("hidden");
        addMessage("Network error while contacting backend.", "bot");
      }
    }

    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      addMessage(text, "user");
      chatInput.value = "";
      sendMessage(text);
    });

    // Welcome message
    window.addEventListener("load", () => {
      addMessage("Hi! ðŸ‘‹ I'm your SchoolData Assistant. Ask me about attendance, marks, fees, hostel info, and more!", "bot");
    });
  </script>
</body>
</html>
